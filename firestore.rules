rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserData().role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'superadmin', 'superuser'];
    }

    function isSuperAdmin() {
      // Incluye 'admin' para compatibilidad con usuarios legacy
      return isAuthenticated() && getUserRole() in ['admin', 'superadmin', 'superuser'];
    }

    function isAuthorized() {
      return isAuthenticated() && getUserRole() in ['viewer', 'admin', 'superadmin', 'superuser'];
    }

    // Multi-tenant: verificar acceso a sitio específico
    function hasSiteAccess(siteId) {
      let userData = getUserData();
      return userData.role in ['admin', 'superadmin', 'superuser']
             || (userData.siteAccess != null && siteId in userData.siteAccess);
    }

    function hasSiteAdminAccess(siteId) {
      let userData = getUserData();
      return userData.role in ['admin', 'superadmin', 'superuser']
             || (userData.siteAccess != null
                 && siteId in userData.siteAccess
                 && userData.siteAccess[siteId].role in ['owner', 'admin']);
    }

    // Multi-distribuidor: verificar acceso al distribuidor
    function hasDistributorAccess(distributorId) {
      let userData = getUserData();
      return userData.role in ['admin', 'superadmin', 'superuser']
             || userData.distributorId == distributorId;
    }

    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAdmin();

      allow create: if isAuthenticated() && request.auth.uid == userId
                    && request.resource.data.role == 'pending';

      allow update: if isAuthenticated() && request.auth.uid == userId
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin']);

      allow update: if isAdmin() && request.auth.uid != userId;
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // SITES COLLECTION (Multi-tenant)
    // ============================================
    match /sites/{siteId} {
      allow read: if isAdmin() || (isAuthorized() && hasSiteAccess(siteId));
      allow create: if isAdmin();
      allow update: if isAdmin() || hasSiteAdminAccess(siteId);
      allow delete: if isSuperAdmin();
    }

    // ============================================
    // CONSENTS COLLECTION (GDPR-COMPLIANT + MULTI-DISTRIBUIDOR)
    // ============================================
    // Soporta DOS flujos de creación:
    // 1. API Backend (Admin SDK) - bypasea estas reglas
    // 2. SDK Directo - con validación de campos obligatorios
    //
    // CAMPOS OBLIGATORIOS para escritura directa desde SDK:
    // - user_hash: string (identificador anónimo)
    // - domain: string (dominio origen)
    // - distributorId: string (ID del distribuidor)
    // - timestamp: debe ser igual a request.time (previene manipulación)
    //
    // CAMPOS LEGACY (API Backend):
    // - siteId, userHash, choices, createdAt, expiresAt
    // ============================================
    match /consents/{consentId} {
      // CREACIÓN: SDK puede crear con validación de campos
      allow create: if request.resource.data.keys().hasAll(['user_hash', 'domain', 'distributorId', 'timestamp'])
                    && request.resource.data.timestamp == request.time;

      // LECTURA: Múltiples criterios de acceso
      allow read: if isAdmin()
                  // Opción 1: Usuario autenticado del mismo distribuidor
                  || (isAuthenticated() && hasDistributorAccess(resource.data.distributorId))
                  // Opción 2: Usuario con acceso al sitio (legacy)
                  || (isAuthorized() && resource.data.siteId != null && hasSiteAccess(resource.data.siteId))
                  // Opción 3: Usuario final consultando su propio rastro (transparencia GDPR)
                  || (request.auth != null
                      && request.auth.token.user_hash != null
                      && resource.data.user_hash == request.auth.token.user_hash);

      // INMUTABILIDAD: Los registros de consentimiento no se pueden modificar ni eliminar
      // Esto garantiza el audit trail requerido por GDPR
      // La eliminación se hace automáticamente vía TTL de Firestore (3 años)
      allow update: if false;
      allow delete: if false;
    }

    // ============================================
    // CONFIG COLLECTION (Configuración de banners)
    // ============================================
    // Lectura pública: El SDK necesita leer textos y colores del banner
    // Escritura restringida: Solo admins del distribuidor
    match /config/{configId} {
      allow read: if true; // SDK necesita acceso público
      allow write: if isAdmin()
                   || (isAuthenticated() && hasDistributorAccess(resource.data.distributorId));
    }

    // ============================================
    // DISTRIBUTORS COLLECTION (Gestión de distribuidores)
    // ============================================
    match /distributors/{distributorId} {
      allow read: if isAuthenticated() && hasDistributorAccess(distributorId);
      allow write: if isSuperAdmin()
                   || (isAuthenticated() && hasDistributorAccess(distributorId)
                       && getUserData().distributorRole == 'admin');
    }

    // ============================================
    // DAILY STATS COLLECTION (Estadísticas agregadas)
    // ============================================
    match /dailyStats/{statsId} {
      allow read: if isAdmin()
                  || (isAuthorized() && hasSiteAccess(resource.data.siteId))
                  || (isAuthenticated() && hasDistributorAccess(resource.data.distributorId));

      // Stats se crean/actualizan vía Cloud Functions o Admin SDK
      allow write: if false;
    }

    // ============================================
    // ORGANIZATIONS COLLECTION (Modelo SaaS)
    // ============================================
    match /organizations/{orgId} {
      allow read, write: if isSuperAdmin();
    }

    // ============================================
    // INVITATIONS COLLECTION (Sistema de invitaciones)
    // ============================================
    match /invitations/{invitationId} {
      // Leer: invitado por email o quien invitó o admin
      allow read: if isAuthenticated() && (
        resource.data.email == request.auth.token.email ||
        resource.data.invitedBy == request.auth.uid ||
        isSuperAdmin()
      );

      // Crear: admins o users con rol de org_owner/org_admin
      allow create: if isAuthenticated() && (
        isSuperAdmin() ||
        (getUserData().orgAccess != null &&
         request.resource.data.organizationId in getUserData().orgAccess &&
         getUserData().orgAccess[request.resource.data.organizationId].role in ['org_owner', 'org_admin'])
      );

      // Actualizar: solo el invitado (para aceptar) o quien invitó (para revocar)
      allow update: if isAuthenticated() && (
        request.auth.token.email == resource.data.email ||
        request.auth.uid == resource.data.invitedBy ||
        isSuperAdmin()
      );

      // No permitir eliminar invitaciones (audit trail)
      allow delete: if false;
    }
  }
}
