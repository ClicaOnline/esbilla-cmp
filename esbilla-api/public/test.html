<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esbilla CMP - Test SDK</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #3D2B1F; }
    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #FFBF00;
      border: 2px solid #3D2B1F;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover { background: #FFA500; }
    code {
      background: #eee;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
    .info { color: #666; font-size: 14px; }

    /* Estilos para la secci√≥n de transparencia */
    .transparency-section {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid #22c55e;
    }
    .transparency-section h2 {
      color: #166534;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .consent-history {
      max-height: 400px;
      overflow-y: auto;
    }
    .consent-record {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .consent-record.accepted { border-left: 4px solid #22c55e; }
    .consent-record.rejected { border-left: 4px solid #ef4444; }
    .consent-record.customized { border-left: 4px solid #f59e0b; }
    .consent-record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .consent-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .consent-badge.accepted { background: #dcfce7; color: #166534; }
    .consent-badge.rejected { background: #fee2e2; color: #991b1b; }
    .consent-badge.customized { background: #fef3c7; color: #92400e; }
    .consent-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      font-size: 13px;
    }
    .consent-detail-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .consent-detail-item strong {
      color: #374151;
    }
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #22c55e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #6b7280;
    }
    .empty-state span {
      font-size: 48px;
      display: block;
      margin-bottom: 10px;
    }
    .export-btn {
      background: #166534;
      color: white;
      border-color: #14532d;
    }
    .export-btn:hover { background: #15803d; }
  </style>
</head>
<body>
  <h1>üåΩ Esbilla CMP - Test del SDK</h1>

  <div class="test-section">
    <h2>Estado Actual</h2>
    <p><strong>Footprint ID:</strong> <code id="footprint-display">Cargando...</code></p>
    <p><strong>Consentimiento guardado:</strong> <code id="consent-display">Ninguno</code></p>
  </div>

  <div class="test-section">
    <h2>Acciones de Prueba</h2>
    <button onclick="clearConsent()">üóëÔ∏è Borrar consentimiento</button>
    <button onclick="clearFootprint()">üîÑ Regenerar Footprint</button>
    <button onclick="location.reload()">‚ôªÔ∏è Recargar p√°gina</button>
  </div>

  <div class="test-section">
    <h3 class="font-bold text-amber-800">Zona de Pruebas de Consentimiento</h3>
  <p class="text-sm text-amber-700 mb-4">
    ‚ö†Ô∏è **Advertencia:** Al interactuar con el banner, se modificar√°n tus preferencias reales de cookies para este dominio.
  </p>
  <button id="btn-test-banner" class="bg-amber-600 text-white px-4 py-2 rounded shadow hover:bg-amber-700 transition">
    Probar el Banner
  </button>
    <h2>Instrucciones</h2>
    <ol>
      <li>Esta es una p√°gina de prueba, Puedes probar el banner en el bot√≥n de arriba</li>
      <li>Acepta o rechaza las cookies</li>
      <li>Deber√≠a aparecer "la mosca" Opcionalmente con el Footprint ID (ej: <code>üç™ ESB-A7F3B2C1</code>)</li>
      <li>Haz clic en la mosca para volver a ver el banner</li>
      <li>Puedes saber el historial de tus consentimientos en la secci√≥n de transparencia</li>
    </ol>
    <p class="info">El Footprint ID se guarda en localStorage y cookies (cross-domain) como <code>esbilla_footprint</code></p>
    <p class="info">üåê <strong>Cross-domain:</strong> El historial muestra consentimientos de todos los dominios del mismo tenant.</p>
  </div>

  <!-- <div class="test-section">
    <h2>Verificar en Dashboard</h2>
    <p>Una vez aceptes/rechaces, busca tu Footprint ID en:</p>
    <p><a href="/dashboard/footprint" target="_blank">Dashboard ‚Üí Buscar Footprint</a></p>
  </div> -->

  <!-- SECCI√ìN DE TRANSPARENCIA: Muestra todos los datos guardados del usuario -->
  <div class="test-section transparency-section">
    <h2>üîç Transparencia: Tus Datos Almacenados</h2>
    <p class="info">
      En cumplimiento con el GDPR, aqu√≠ puedes ver <strong>todos los datos</strong> que hemos
      almacenado sobre tus decisiones de consentimiento. Esta informaci√≥n se conserva durante
      3 a√±os para cumplir con los requisitos de auditor√≠a.
    </p>

    <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
      <button onclick="loadConsentHistory()">üîÑ Cargar mi historial</button>
      <button onclick="exportMyData()" class="export-btn">üì• Exportar mis datos (JSON)</button>
    </div>

    <div id="consent-history-container" class="consent-history">
      <div class="empty-state">
        <span>üîê</span>
        <p>Haz clic en "Cargar mi historial" para ver tus registros de consentimiento.</p>
      </div>
    </div>

    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
      <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #374151;">üìã ¬øQu√© datos guardamos?</h3>
      <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #6b7280;">
        <li><strong>Footprint ID:</strong> Identificador an√≥nimo de tu navegador (no te identifica personalmente)</li>
        <li><strong>Decisiones:</strong> Si aceptaste/rechazaste cookies de analytics y marketing</li>
        <li><strong>Fecha y hora:</strong> Cu√°ndo tomaste cada decisi√≥n</li>
        <li><strong>IP Hash:</strong> Un hash irreversible de tu IP (no almacenamos la IP real)</li>
        <li><strong>Navegador:</strong> Informaci√≥n t√©cnica del navegador para estad√≠sticas</li>
        <li><strong>Expiraci√≥n:</strong> Fecha en que se eliminar√°n autom√°ticamente (3 a√±os)</li>
      </ul>
    </div>
  </div>

  <script>
    // ============================================
    // FUNCIONES HELPER PARA CROSS-DOMAIN STORAGE
    // ============================================
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? decodeURIComponent(match[2]) : null;
    }

    function getParentDomain() {
      const hostname = window.location.hostname;
      if (hostname === 'localhost' || /^\d+\.\d+\.\d+\.\d+$/.test(hostname)) return null;
      const parts = hostname.split('.');
      if (parts.length > 2) return '.' + parts.slice(-2).join('.');
      if (parts.length === 2) return '.' + hostname;
      return null;
    }

    function deleteCookie(name) {
      const domain = getParentDomain();
      // Borrar en dominio actual
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      // Borrar en dominio padre si existe
      if (domain) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${domain}`;
      }
    }

    // Lee de cookie primero (cross-domain), fallback a localStorage
    function getStorageItem(key) {
      const cookieVal = getCookie(key);
      if (cookieVal) return cookieVal;
      try {
        return localStorage.getItem(key);
      } catch (e) {
        return null;
      }
    }

    // Mostrar estado actual
    function updateDisplay() {
      const footprint = getStorageItem('esbilla_footprint') || 'No generado';
      const consent = getStorageItem('esbilla_consent');

      document.getElementById('footprint-display').textContent = footprint;
      document.getElementById('consent-display').textContent = consent || 'Ninguno';
    }

    function clearConsent() {
      localStorage.removeItem('esbilla_consent');
      deleteCookie('esbilla_consent');
      alert('Consentimiento borrado. Recarga la p√°gina para ver el banner.');
      updateDisplay();
    }

    function clearFootprint() {
      localStorage.removeItem('esbilla_footprint');
      localStorage.removeItem('esbilla_consent');
      deleteCookie('esbilla_footprint');
      deleteCookie('esbilla_consent');
      alert('Footprint y consentimiento borrados. Recarga la p√°gina.');
      updateDisplay();
    }

    // Actualizar display inicial
    updateDisplay();

    // Observar cambios en localStorage
    window.addEventListener('storage', updateDisplay);
    setInterval(updateDisplay, 1000);

    // ============================================
    // TRANSPARENCIA: Cargar historial de consentimiento
    // ============================================
    let consentHistoryData = [];

    async function loadConsentHistory() {
      const footprint = getStorageItem('esbilla_footprint');
      const container = document.getElementById('consent-history-container');

      if (!footprint) {
        container.innerHTML = `
          <div class="empty-state">
            <span>‚ö†Ô∏è</span>
            <p>No tienes un Footprint ID. Interact√∫a con el banner de cookies primero.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div style="text-align: center; padding: 30px;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 10px; color: #6b7280;">Cargando tu historial...</p>
        </div>
      `;

      try {
        // Llamar al API para obtener el historial (endpoint p√∫blico de transparencia)
        const response = await fetch(`/api/consent/history/${footprint}`);

        if (!response.ok) {
          throw new Error(`Error ${response.status}`);
        }

        const data = await response.json();
        consentHistoryData = data.records || [];

        if (consentHistoryData.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <span>üì≠</span>
              <p>No encontramos registros para tu Footprint ID.</p>
              <p style="font-size: 12px;">Esto puede significar que a√∫n no has dado tu consentimiento o que los datos ya expiraron.</p>
            </div>
          `;
          return;
        }

        renderConsentHistory(consentHistoryData);
      } catch (err) {
        console.error('Error cargando historial:', err);
        container.innerHTML = `
          <div class="empty-state">
            <span>‚ùå</span>
            <p>Error al cargar tu historial: ${err.message}</p>
            <p style="font-size: 12px;">El servidor podr√≠a no estar disponible o no tener este endpoint habilitado.</p>
          </div>
        `;
      }
    }

    function renderConsentHistory(records) {
      const container = document.getElementById('consent-history-container');

      const html = records.map(record => {
        const choices = record.choices || {};
        const isAccepted = choices.analytics && choices.marketing;
        const isRejected = !choices.analytics && !choices.marketing;
        const type = isAccepted ? 'accepted' : (isRejected ? 'rejected' : 'customized');
        const typeLabel = isAccepted ? '‚úÖ Aceptado todo' : (isRejected ? '‚ùå Rechazado todo' : '‚öôÔ∏è Personalizado');
        const typeBadgeClass = type;

        const date = new Date(record.timestamp || record.createdAt);
        const expiresAt = record.expiresAt ? new Date(record.expiresAt) : null;

        return `
          <div class="consent-record ${type}">
            <div class="consent-record-header">
              <span class="consent-badge ${typeBadgeClass}">${typeLabel}</span>
              <span style="color: #6b7280; font-size: 13px;">
                ${date.toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' })}
                a las ${date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
              </span>
            </div>
            <div class="consent-details">
              <div class="consent-detail-item">
                <span>üìä</span>
                <strong>Analytics:</strong>
                <span>${choices.analytics ? '‚úÖ S√≠' : '‚ùå No'}</span>
              </div>
              <div class="consent-detail-item">
                <span>üì¢</span>
                <strong>Marketing:</strong>
                <span>${choices.marketing ? '‚úÖ S√≠' : '‚ùå No'}</span>
              </div>
              <div class="consent-detail-item">
                <span>üéØ</span>
                <strong>Acci√≥n:</strong>
                <span>${record.action || 'desconocida'}</span>
              </div>
              <div class="consent-detail-item">
                <span>üåê</span>
                <strong>Dominio:</strong>
                <span>${record.metadata?.domain || record.domain || 'N/A'}</span>
              </div>
              <div class="consent-detail-item">
                <span>üîê</span>
                <strong>IP Hash:</strong>
                <code style="font-size: 11px;">${record.ipHash || 'N/A'}</code>
              </div>
              ${expiresAt ? `
              <div class="consent-detail-item">
                <span>‚è≥</span>
                <strong>Expira:</strong>
                <span>${expiresAt.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <p style="margin-bottom: 15px; color: #166534; font-weight: 500;">
          üìú Se encontraron ${records.length} registro(s) de consentimiento
        </p>
        ${html}
      `;
    }

    function exportMyData() {
      const footprint = getStorageItem('esbilla_footprint');

      if (consentHistoryData.length === 0) {
        alert('Primero carga tu historial antes de exportar.');
        return;
      }

      const exportData = {
        footprintId: footprint,
        exportDate: new Date().toISOString(),
        totalRecords: consentHistoryData.length,
        gdprInfo: {
          dataController: 'Esbilla CMP',
          retentionPeriod: '3 a√±os (1095 d√≠as)',
          legalBasis: 'Consentimiento del usuario (Art. 6.1.a GDPR)',
          rights: 'Acceso, rectificaci√≥n, supresi√≥n, portabilidad (Art. 15-20 GDPR)'
        },
        records: consentHistoryData
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `esbilla-mis-datos-${footprint}-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>

  <!-- Cargar el SDK de Esbilla -->
  <script src="/sdk.js" data-id="test-local"></script>
</body>
</html>
