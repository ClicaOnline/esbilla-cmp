name: Deploy Development

on:
  push:
    branches:
      - develop

jobs:
  deploy-landing:
    name: Deploy Landing to Firebase (Dev)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: esbilla-public
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean and install dependencies
        run: |
          rm -f package-lock.json
          rm -rf node_modules
          npm install
          npm install --save-optional @rollup/rollup-linux-x64-gnu

      - name: Build Landing
        run: npm run build --workspace=esbilla-public
        env:
          VITE_ENV: development

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting:dev --project esbilla-cmp --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_DEV }}

  deploy-api:
    name: Deploy API to Cloud Run (Dev)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: esbilla-cmp

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and Push Docker Image
        working-directory: esbilla-api
        run: |
          docker build -t gcr.io/esbilla-cmp/esbilla-api:${{ github.sha }} .
          docker push gcr.io/esbilla-cmp/esbilla-api:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy esbilla-api-dev \
            --image gcr.io/esbilla-cmp/esbilla-api:${{ github.sha }} \
            --platform managed \
            --region europe-west4 \
            --allow-unauthenticated \
            --set-env-vars NODE_ENV=development \
            --memory 512Mi \
            --cpu 1 \
            --max-instances 10 \
            --timeout 60s \
            --project esbilla-cmp

  # deploy-dashboard:
  #   name: Deploy Dashboard to Firebase (Dev)
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: esbilla-dashboard
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: esbilla-dashboard/package-lock.json

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Build Dashboard
  #       run: npm run build
  #       env:
  #         VITE_ENV: development
  #         VITE_API_URL: https://api-dev.esbilla.com
  #         VITE_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID_DEV }}
  #         VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY_DEV }}
  #         VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN_DEV }}
  #         VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET_DEV }}
  #         VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID_DEV }}
  #         VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID_DEV }}

  #     - name: Deploy to Firebase Hosting
  #       run: |
  #         npm install -g firebase-tools
  #         firebase deploy --only hosting:dashboard-dev --project esbilla-cmp --non-interactive
  #       working-directory: .
  #       env:
  #         FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_DEV }}

  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-landing, deploy-api]
    if: success()
    steps:
      - name: Send notification
        run: |
          echo "âœ… Development deployment successful!"
          echo "Landing: https://dev.esbilla.com"
          echo "API: https://api-dev.esbilla.com"
          echo "Dashboard: https://app-dev.esbilla.com"
