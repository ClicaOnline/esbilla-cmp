name: Deploy Production

on:
  push:
    branches:
      - main

jobs:
  deploy-landing:
    name: Deploy Landing to Firebase (Prod)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: esbilla-public
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean and install dependencies
        run: |
          rm -f package-lock.json
          rm -rf node_modules
          npm install
          npm install --save-optional @rollup/rollup-linux-x64-gnu
          npm install sharp --workspace=esbilla-public

      - name: Build Landing
        run: npm run build --workspace=esbilla-public
        env:
          VITE_ENV: production

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting:prod --project esbilla-cmp --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PROD }}

  deploy-api:
    name: Deploy API to Cloud Run (Prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: esbilla-cmp

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build and Push Docker Image
        working-directory: esbilla-api
        run: |
          docker build -t gcr.io/esbilla-cmp/esbilla-api:${{ github.sha }} \
                       -t gcr.io/esbilla-cmp/esbilla-api:latest .
          docker push gcr.io/esbilla-cmp/esbilla-api:${{ github.sha }}
          docker push gcr.io/esbilla-cmp/esbilla-api:latest

      - name: Validate SMTP Secrets
        run: |
          if [ -z "${{ secrets.SMTP_HOST_PROD }}" ]; then
            echo "ERROR: SMTP_HOST_PROD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SMTP_PORT_PROD }}" ]; then
            echo "ERROR: SMTP_PORT_PROD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SMTP_USER_PROD }}" ]; then
            echo "ERROR: SMTP_USER_PROD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SMTP_PASS_PROD }}" ]; then
            echo "ERROR: SMTP_PASS_PROD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.FROM_EMAIL_PROD }}" ]; then
            echo "ERROR: FROM_EMAIL_PROD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.FRONTEND_URL_PROD }}" ]; then
            echo "ERROR: FRONTEND_URL_PROD secret is not set"
            exit 1
          fi
          echo "All SMTP secrets are configured âœ“"

      - name: Deploy to Cloud Run
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST_PROD }}
          SMTP_PORT: ${{ secrets.SMTP_PORT_PROD }}
          SMTP_USER: ${{ secrets.SMTP_USER_PROD }}
          SMTP_PASS: ${{ secrets.SMTP_PASS_PROD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL_PROD }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL_PROD }}
        run: |
          gcloud run deploy esbilla-api \
            --image gcr.io/esbilla-cmp/esbilla-api:${{ github.sha }} \
            --platform managed \
            --region europe-west4 \
            --allow-unauthenticated \
            --update-env-vars "NODE_ENV=production,SMTP_HOST=${SMTP_HOST},SMTP_PORT=${SMTP_PORT},SMTP_USER=${SMTP_USER},SMTP_PASS=${SMTP_PASS},FROM_EMAIL=${FROM_EMAIL},FRONTEND_URL=${FRONTEND_URL}" \
            --memory 1Gi \
            --cpu 2 \
            --min-instances 1 \
            --max-instances 50 \
            --timeout 60s \
            --concurrency 80 \
            --project esbilla-cmp

  deploy-dashboard:
    name: Deploy Dashboard to Firebase (Prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean and install root dependencies
        run: |
          rm -f package-lock.json
          rm -rf node_modules
          npm install

      - name: Install dashboard dependencies
        run: |
          rm -f package-lock.json
          rm -rf node_modules
          npm install
          npm install --save-optional @rollup/rollup-linux-x64-gnu
        working-directory: esbilla-dashboard

      - name: Fix binaries permissions
        run: chmod +x node_modules/.bin/* esbilla-dashboard/node_modules/.bin/* 2>/dev/null || true

      - name: Build Dashboard
        run: npm run build
        working-directory: esbilla-dashboard
        env:
          VITE_ENV: production
          VITE_API_URL: https://api.esbilla.com
          VITE_FIREBASE_PROJECT_ID: esbilla-cmp
          VITE_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY_PROD }}
          VITE_FIREBASE_AUTH_DOMAIN: app.esbilla.com
          VITE_FIREBASE_STORAGE_BUCKET: esbilla-cmp.firebasestorage.app
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID_PROD }}
          VITE_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID_PROD }}

      - name: Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools
          firebase deploy --only hosting:dashboard-prod --project esbilla-cmp --non-interactive
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN_PROD }}

  create-release-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: [deploy-landing, deploy-api, deploy-dashboard]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=v$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.package_version.outputs.version }}-${{ github.run_number }}
          release_name: Release ${{ steps.package_version.outputs.version }}-${{ github.run_number }}
          body: |
            Production deployment from commit ${{ github.sha }}

            **Deployed to:**
            - Landing: https://esbilla.com
            - API: https://api.esbilla.com
            - Dashboard: https://app.esbilla.com
          draft: false
          prerelease: false

  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-landing, deploy-api, deploy-dashboard]
    if: success()
    steps:
      - name: Send notification
        run: |
          echo "ðŸš€ Production deployment successful!"
          echo "Landing: https://esbilla.com"
          echo "API: https://api.esbilla.com"
          echo "Dashboard: https://app.esbilla.com"
